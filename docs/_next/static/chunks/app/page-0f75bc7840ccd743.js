(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{5642:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>w});var a=n(5155),r=n(4520),i=n(4935),s=n(4045),l=n(2139),d=n(2115),u=n(556),o=n(9941),c=n(3195),p=n(7417),y=n(6369),m=n(161),f=n(4710),h=n(8245);let x=[{type:"constructor",inputs:[{name:"_feeReceiver",type:"address"}],stateMutability:"nonpayable"},{type:"function",name:"ACTION_COOLDOWN",inputs:[],outputs:[{name:"",type:"uint256"}],stateMutability:"view"},{type:"function",name:"FEE_BPS",inputs:[],outputs:[{name:"",type:"uint256"}],stateMutability:"view"},{type:"function",name:"createRound",inputs:[{name:"entryFee",type:"uint256"},{name:"duration",type:"uint256"}],outputs:[{name:"roundId",type:"uint256"}],stateMutability:"nonpayable"},{type:"function",name:"finalizeRound",inputs:[{name:"roundId",type:"uint256"}],outputs:[],stateMutability:"nonpayable"},{type:"function",name:"getPlayers",inputs:[{name:"roundId",type:"uint256"}],outputs:[{name:"",type:"address[]"}],stateMutability:"view"},{type:"function",name:"getScore",inputs:[{name:"roundId",type:"uint256"},{name:"player",type:"address"}],outputs:[{name:"",type:"uint256"}],stateMutability:"view"},{type:"function",name:"joinRound",inputs:[{name:"roundId",type:"uint256"}],outputs:[],stateMutability:"payable"},{type:"function",name:"joined",inputs:[{name:"",type:"uint256"},{name:"",type:"address"}],outputs:[{name:"",type:"bool"}],stateMutability:"view"},{type:"function",name:"nextRoundId",inputs:[],outputs:[{name:"",type:"uint256"}],stateMutability:"view"},{type:"function",name:"rounds",inputs:[{name:"",type:"uint256"}],outputs:[{name:"creator",type:"address"},{name:"entryFee",type:"uint256"},{name:"startTime",type:"uint256"},{name:"endTime",type:"uint256"},{name:"pool",type:"uint256"},{name:"finalized",type:"bool"},{name:"playerCount",type:"uint256"}],stateMutability:"view"},{type:"function",name:"submitAction",inputs:[{name:"roundId",type:"uint256"}],outputs:[],stateMutability:"nonpayable"},{type:"function",name:"submitActions",inputs:[{name:"roundId",type:"uint256"},{name:"amount",type:"uint256"}],outputs:[],stateMutability:"nonpayable"},{type:"event",name:"ActionsSubmitted",inputs:[{name:"roundId",type:"uint256",indexed:!0},{name:"player",type:"address",indexed:!0},{name:"amount",type:"uint256",indexed:!1},{name:"newScore",type:"uint256",indexed:!1}]},{type:"event",name:"ActionSubmitted",inputs:[{name:"roundId",type:"uint256",indexed:!0},{name:"player",type:"address",indexed:!0},{name:"newScore",type:"uint256",indexed:!1}]},{type:"event",name:"RoundCreated",inputs:[{name:"roundId",type:"uint256",indexed:!0},{name:"creator",type:"address",indexed:!0},{name:"entryFee",type:"uint256",indexed:!1},{name:"startTime",type:"uint256",indexed:!1},{name:"endTime",type:"uint256",indexed:!1}]},{type:"event",name:"RoundFinalized",inputs:[{name:"roundId",type:"uint256",indexed:!0},{name:"winner",type:"address",indexed:!0},{name:"payout",type:"uint256",indexed:!1},{name:"fee",type:"uint256",indexed:!1}]},{type:"event",name:"RoundJoined",inputs:[{name:"roundId",type:"uint256",indexed:!0},{name:"player",type:"address",indexed:!0}]}],b="0x5258b89e2550E317499F14A0750aEE236152D791";function v(e){let{active:t,onDistance:n}=e,r=(0,d.useRef)(null),i=(0,d.useRef)(null),[s,l]=(0,d.useState)("ready"),u=(0,d.useRef)("ready"),[o,c]=(0,d.useState)(0),p=(0,d.useRef)({y:220,vy:0}),y=(0,d.useRef)([]),m=(0,d.useMemo)(()=>({gravity:1600,flapVy:-520,speed:220,pipeEvery:1.35,pipeWidth:60,gap:140,birdX:90,birdR:14}),[]);return(0,d.useEffect)(()=>{if(!t){i.current&&cancelAnimationFrame(i.current),i.current=null,u.current="ready",l("ready");return}let e=r.current;if(!e)return;let a=e.getContext("2d");if(!a)return;let s=performance.now(),d=0,f=()=>{let t=Math.max(1,Math.floor(window.devicePixelRatio||1)),{width:n,height:r}=e.getBoundingClientRect();e.width=Math.floor(n*t),e.height=Math.floor(r*t),a.setTransform(t,0,0,t,0,0)};f(),window.addEventListener("resize",f);let h=t=>{let r=Math.min(.033,(t-s)/1e3);if(s=t,"running"===u.current){if(p.current.vy+=m.gravity*r,p.current.y+=p.current.vy*r,(d+=r)>=m.pipeEvery){d=0;let t=60+Math.random()*(e.clientHeight-20-120);y.current.push({x:e.clientWidth+40,gapY:t,passed:!1})}for(let e of y.current)e.x-=m.speed*r;y.current=y.current.filter(e=>e.x>-m.pipeWidth-10);let t=m.speed*r;c(e=>e+t),n(t/10),(()=>{let t=e.clientHeight,n=p.current;if(n.y-m.birdR<0||n.y+m.birdR>t-20)return!0;for(let e of y.current){if(!(m.birdX+m.birdR>e.x&&m.birdX-m.birdR<e.x+m.pipeWidth))continue;let t=e.gapY-m.gap/2,a=e.gapY+m.gap/2,r=n.y-m.birdR<t,i=n.y+m.birdR>a;if(r||i)return!0}return!1})()&&(u.current="crashed",l("crashed"))}(()=>{let t=e.clientWidth,n=e.clientHeight;a.fillStyle="#0b1220",a.fillRect(0,0,t,n),a.fillStyle="rgba(255,255,255,0.06)";for(let e=0;e<24;e++){let r=(97*e+3*o)%t,i=53*e%n;a.fillRect(r,i,2,2)}for(let e of(a.fillStyle="#22c55e",y.current)){let t=e.gapY-m.gap/2,r=e.gapY+m.gap/2,i=n-r;a.fillRect(e.x,0,m.pipeWidth,t),a.fillRect(e.x,r,m.pipeWidth,i)}let r=p.current;a.fillStyle="#ff4d4d",a.beginPath(),a.arc(m.birdX,r.y,m.birdR,0,2*Math.PI),a.fill(),a.fillStyle="rgba(255,255,255,0.06)",a.fillRect(0,n-20,t,20),a.fillStyle="rgba(255,255,255,0.85)",a.font="600 14px system-ui","ready"===u.current?a.fillText("Tap anywhere to flap",14,22):"crashed"===u.current&&a.fillText("Crashed — tap to restart",14,22)})(),i.current=requestAnimationFrame(h)};return i.current=requestAnimationFrame(h),()=>{i.current&&cancelAnimationFrame(i.current),i.current=null,window.removeEventListener("resize",f)}},[t,m,n]),(0,a.jsx)("div",{className:"dash-root",onPointerDown:e=>{e.preventDefault(),t&&("ready"===u.current&&(u.current="running",l("running")),"crashed"===u.current&&(p.current={y:220,vy:0},y.current=[],c(0),u.current="ready",l("ready"),u.current="running",l("running")),p.current.vy=m.flapVy)},onContextMenu:e=>e.preventDefault(),children:(0,a.jsx)("canvas",{ref:r,className:"dash-canvas"})})}function g(e){let{address:t,demo:n}=e,r=!!n,[i,s]=(0,d.useState)(null),[l,g]=(0,d.useState)([]),[w,j]=(0,d.useState)(0),[N,R]=(0,d.useState)(0n),[C,S]=(0,d.useState)(!1),I=(0,u.e)(),E=(0,o.i)(),{switchChainAsync:M}=(0,c.R)(),{writeContractAsync:k,isPending:T}=(0,p.x)(),[F,D]=(0,d.useState)(!1),[A,B]=(0,d.useState)(null),[L,P]=(0,d.useState)(!1),[z]=(0,d.useState)(.01),[W,_]=(0,d.useState)(0),[H,q]=(0,d.useState)([]);(0,d.useEffect)(()=>{if(!r||null!==A)return;let e=Math.floor(Date.now()/1e3);s(0n),B(e+120),q([t,"0x000000000000000000000000000000000000dEaD","0x000000000000000000000000000000000000bEEF"]),g([{address:t,score:0n},{address:"0x000000000000000000000000000000000000dEaD",score:3n},{address:"0x000000000000000000000000000000000000bEEF",score:1n}]),_(.03),D(!0),R(0n)},[r,A,t]),(0,d.useEffect)(()=>{if(!r||!A)return;let e=()=>{j(Math.max(0,A-Math.floor(Date.now()/1e3)))};e();let t=setInterval(e,1e3);return()=>clearInterval(t)},[r,A]),(0,d.useEffect)(()=>{if(!r||L)return;let e=setInterval(()=>{g(e=>{let n=e.map(e=>({...e}));for(let e of n)e.address.toLowerCase()!==t.toLowerCase()&&.55>Math.random()&&(e.score=e.score+1n);return n.sort((e,t)=>t.score>e.score?1:t.score<e.score?-1:0),n})},2500);return()=>clearInterval(e)},[r,L,t]);let{data:O,refetch:J}=(0,y.Q)({address:b,abi:x,functionName:"nextRoundId",query:{enabled:!r}});(0,d.useEffect)(()=>{!r&&void 0!==O&&O>0n&&s(O-1n)},[O,r]);let{data:Y,refetch:X}=(0,y.Q)({address:b,abi:x,functionName:"rounds",args:null!==i?[i]:void 0,query:{enabled:!r&&null!==i}}),{data:Q,refetch:V}=(0,y.Q)({address:b,abi:x,functionName:"joined",args:null!==i?[i,t]:void 0,query:{enabled:!r&&null!==i}}),[G,K,U,Z,$,ee,et]=null!=Y?Y:[void 0,0n,0n,0n,0n,!1,0n],en=A?BigInt(A):0n,ea=r?en:null!=Z?Z:0n,er=r?L:null!=ee&&ee,ei=r?(0,f.g)(z.toString()):null!=K?K:0n,es=r?(0,f.g)(W.toString()):null!=$?$:0n,el=r?BigInt(H.length):null!=et?et:0n,ed=r?F:null!=Q&&Q,eu=BigInt(Math.floor(Date.now()/1e3)),eo=ea>0n&&eu<ea&&!er,ec=ea>0n&&eu>=ea;(0,d.useEffect)(()=>{if(r||!Z||0n===Z)return;let e=()=>{j(Math.max(0,Number(Z)-Math.floor(Date.now()/1e3)))};e();let t=setInterval(e,1e3);return()=>clearInterval(t)},[Z,r]);let ep=(0,d.useCallback)(async()=>{if(!r&&null!==i&&I)try{let e=await I.readContract({address:b,abi:x,functionName:"getPlayers",args:[i]}),n=await Promise.all(e.map(async e=>{let t=await I.readContract({address:b,abi:x,functionName:"getScore",args:[i,e]});return{address:e,score:t}}));n.sort((e,t)=>t.score>e.score?1:t.score<e.score?-1:0),g(n);let a=n.find(e=>e.address.toLowerCase()===t.toLowerCase());a&&R(a.score)}catch(e){}},[i,I,t,r]);(0,d.useEffect)(()=>{ep()},[ep]),(0,d.useEffect)(()=>{if(r||!eo)return;let e=setInterval(ep,3e3);return()=>clearInterval(e)},[eo,ep,r]),(0,m.x)({address:b,abi:x,eventName:"ActionsSubmitted",enabled:!r,onLogs(){ep()}});let ey=(0,d.useRef)(0),em=(0,d.useRef)(null),ef=(0,d.useRef)(0),eh=(0,d.useCallback)(async()=>{if(r){let e=Math.floor(ey.current);if(e<=0)return;ey.current-=e,R(t=>t+BigInt(e)),g(n=>{let a=n.map(e=>({...e})),r=a.findIndex(e=>e.address.toLowerCase()===t.toLowerCase());return r>=0&&(a[r].score=a[r].score+BigInt(e)),a.sort((e,t)=>t.score>e.score?1:t.score<e.score?-1:0),a});return}if(!eo||!ed||null===i||em.current)return;let e=Date.now(),n=Math.floor(ey.current);if(n<=0)return;let a=e-ef.current;if(!(n<25)||!(a<3e3)){ey.current-=n,em.current={amount:n},ef.current=e;try{await k({address:b,abi:x,functionName:"submitActions",args:[i,BigInt(n)]}),R(e=>e+BigInt(n)),ep()}catch(e){ey.current+=n}finally{em.current=null}}},[r,eo,ed,i,k,ep,t]),ex=(0,d.useCallback)(e=>{eo&&ed&&(e<=0||(ey.current+=e,eh()))},[eo,ed,eh]);async function eb(){if(r){let e=Math.floor(Date.now()/1e3);P(!1),B(e+120),g([{address:t,score:0n},{address:"0x000000000000000000000000000000000000dEaD",score:0n},{address:"0x000000000000000000000000000000000000bEEF",score:0n}]),R(0n),_(.03),D(!0);return}await k({address:b,abi:x,functionName:"createRound",args:[(0,f.g)("0.01"),120n]}),await J()}async function ev(){if(r)return void D(!0);null!==i&&void 0!==K&&(await k({address:b,abi:x,functionName:"joinRound",args:[i],value:K}),await V(),await X(),ep())}async function eg(){if(r)return void P(!0);null!==i&&(await k({address:b,abi:x,functionName:"finalizeRound",args:[i]}),await X(),ep())}(0,d.useEffect)(()=>{if(!eo)return;let e=setInterval(()=>{eh()},500);return()=>clearInterval(e)},[eo,eh]);let ew=(0,d.useMemo)(()=>[31337,6343],[]).includes(E);if(!r&&!ew)return(0,a.jsxs)("div",{className:"no-round",children:[(0,a.jsx)("p",{children:"Wrong network. This app isn’t deployed on your current chain."}),(0,a.jsx)("p",{style:{opacity:.8,fontSize:14},children:"Switch to Anvil (local) for now. MegaETH support will be enabled once the chain is live and we deploy the contract."}),(0,a.jsx)("button",{className:"action-btn",onClick:async()=>{try{await M({chainId:31337})}catch(e){}},children:"Switch network"})]});if(null===i||!r&&0n===O)return(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"no-round",children:(0,a.jsx)("p",{children:"No rounds yet"})}),(0,a.jsx)("button",{className:"action-btn",onClick:eb,disabled:T,children:T?"Creating...":"Create Round (0.01 ETH, 2 min)"})]});let ej=N+BigInt(Math.floor(ey.current));return(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"card",children:[(0,a.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,a.jsxs)("h2",{children:["Round #",i.toString()]}),(0,a.jsx)("span",{className:"badge ".concat(eo?"badge-active":"badge-ended"),children:er?"Finalized":eo?"Active":"Ended"})]}),(0,a.jsxs)("div",{className:"round-info",style:{marginTop:8},children:[(0,a.jsxs)("span",{children:["Entry: ",(0,h.c)(ei)," ETH"]}),(0,a.jsxs)("span",{children:["Pool: ",(0,h.c)(es)," ETH"]}),(0,a.jsxs)("span",{children:["Players: ",el.toString()]})]})]}),eo&&(0,a.jsxs)("div",{className:"dash-wrap",children:[(0,a.jsxs)("div",{className:"dash-hud",children:[(0,a.jsxs)("div",{className:"dash-hud-left",children:[(0,a.jsx)("div",{className:"dash-hud-label",children:"TIME"}),(0,a.jsx)("div",{className:"dash-hud-value",children:(e=>{let t=Math.floor(e/60);return"".concat(t,":").concat((e%60).toString().padStart(2,"0"))})(w)})]}),(0,a.jsxs)("div",{className:"dash-hud-right",children:[(0,a.jsx)("div",{className:"dash-hud-label",children:"DIST"}),(0,a.jsx)("div",{className:"dash-hud-value",children:ej.toString()})]})]}),(0,a.jsx)("button",{className:"dash-standings",onClick:()=>S(!0),children:"Standings"}),(0,a.jsx)(v,{active:eo&&ed,onDistance:ex}),!ed&&(0,a.jsx)("div",{className:"dash-overlay",children:(0,a.jsxs)("div",{className:"dash-overlay-inner",children:[(0,a.jsx)("p",{style:{marginBottom:10,opacity:.9},children:"Join to start dashing."}),(0,a.jsx)("button",{className:"action-btn",onClick:ev,disabled:T,children:T?"Joining...":r?"Join Round (demo)":"Join Round (".concat((0,h.c)(ei)," ETH)")})]})})]}),ec&&!er&&(0,a.jsx)("button",{className:"action-btn",onClick:eg,disabled:T,children:T?"Finalizing...":r?"Finalize (demo)":"Finalize Round"}),(er||ec)&&(0,a.jsx)("button",{className:"action-btn",onClick:eb,disabled:T,children:T?"Creating...":r?"Restart Demo Round":"Create New Round"}),C&&(0,a.jsx)("div",{className:"drawer-backdrop",onClick:()=>S(!1),children:(0,a.jsxs)("div",{className:"drawer",onClick:e=>e.stopPropagation(),children:[(0,a.jsxs)("div",{className:"drawer-header",children:[(0,a.jsx)("h3",{children:"Standings"}),(0,a.jsx)("button",{className:"drawer-close",onClick:()=>S(!1),children:"Close"})]}),0===l.length?(0,a.jsx)("p",{style:{color:"var(--muted)"},children:"No players yet"}):(0,a.jsx)("ul",{className:"leaderboard",children:l.map((e,n)=>{let r;return(0,a.jsxs)("li",{children:[(0,a.jsxs)("span",{className:"rank",children:["#",n+1]}),(0,a.jsx)("span",{className:"addr",children:e.address.toLowerCase()===t.toLowerCase()?"You":(r=e.address,"".concat(r.slice(0,6),"...").concat(r.slice(-4)))}),(0,a.jsx)("span",{className:"score",children:e.score.toString()})]},e.address)})}),!r&&(0,a.jsx)("div",{className:"status",style:{marginTop:10},children:"Batching commits every ~3s (or when distance builds up). Tx frequency stays sane."})]})})]})}function w(){let{address:e,isConnected:t}=(0,r.F)(),{connect:n}=(0,i.e)(),{disconnect:d}=(0,s.u)();return(0,a.jsxs)("div",{className:"container",children:[(0,a.jsxs)("header",{className:"header",children:[(0,a.jsx)("h1",{children:"MegaRally"}),t?(0,a.jsxs)("button",{className:"connect-btn",onClick:()=>d(),children:[null==e?void 0:e.slice(0,6),"...",null==e?void 0:e.slice(-4)]}):(0,a.jsx)("button",{className:"connect-btn",onClick:()=>n({connector:(0,l.b)()}),children:"Connect"})]}),t?(0,a.jsx)(g,{address:e,demo:!1}):(0,a.jsx)("div",{className:"no-round",children:(0,a.jsx)("p",{children:"Connect your wallet to play"})})]})}},9249:(e,t,n)=>{Promise.resolve().then(n.bind(n,5642))}},e=>{e.O(0,[496,109,441,255,358],()=>e(e.s=9249)),_N_E=e.O()}]);