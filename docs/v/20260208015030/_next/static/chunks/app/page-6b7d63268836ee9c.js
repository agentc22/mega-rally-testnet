(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[974],{639:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>j});var r=n(5155),a=n(4520),i=n(4935),s=n(4045),l=n(2139),u=n(2115),o=n(556),d=n(9941),c=n(3195),p=n(7417),y=n(6369),m=n(161),f=n(4710),h=n(3168),b=n(8245);let x=[{type:"constructor",inputs:[{name:"_feeReceiver",type:"address"}],stateMutability:"nonpayable"},{type:"function",name:"ACTION_COOLDOWN",inputs:[],outputs:[{name:"",type:"uint256"}],stateMutability:"view"},{type:"function",name:"FEE_BPS",inputs:[],outputs:[{name:"",type:"uint256"}],stateMutability:"view"},{type:"function",name:"MAX_ATTEMPTS",inputs:[],outputs:[{name:"",type:"uint8"}],stateMutability:"view"},{type:"function",name:"MAX_OBSTACLES_PER_SECOND",inputs:[],outputs:[{name:"",type:"uint8"}],stateMutability:"view"},{type:"function",name:"MAX_SCORE_PER_OBSTACLE",inputs:[],outputs:[{name:"",type:"uint32"}],stateMutability:"view"},{type:"function",name:"isOperator",inputs:[{name:"",type:"address"},{name:"",type:"address"}],outputs:[{name:"",type:"bool"}],stateMutability:"view"},{type:"function",name:"setOperator",inputs:[{name:"operator",type:"address"},{name:"allowed",type:"bool"}],outputs:[],stateMutability:"nonpayable"},{type:"function",name:"obstaclePassed",inputs:[{name:"roundId",type:"uint256"},{name:"entryIndex_",type:"uint32"},{name:"obstacleCount_",type:"uint32"},{name:"deltaScore",type:"uint32"}],outputs:[],stateMutability:"nonpayable"},{type:"function",name:"obstaclePassedFor",inputs:[{name:"roundId",type:"uint256"},{name:"player",type:"address"},{name:"entryIndex_",type:"uint32"},{name:"obstacleCount_",type:"uint32"},{name:"deltaScore",type:"uint32"}],outputs:[],stateMutability:"nonpayable"},{type:"function",name:"attemptsUsed",inputs:[{name:"roundId",type:"uint256"},{name:"player",type:"address"}],outputs:[{name:"",type:"uint8"}],stateMutability:"view"},{type:"function",name:"currentAttemptScore",inputs:[{name:"roundId",type:"uint256"},{name:"player",type:"address"}],outputs:[{name:"",type:"uint256"}],stateMutability:"view"},{type:"function",name:"totalScore",inputs:[{name:"roundId",type:"uint256"},{name:"player",type:"address"}],outputs:[{name:"",type:"uint256"}],stateMutability:"view"},{type:"function",name:"entryIndex",inputs:[{name:"roundId",type:"uint256"},{name:"player",type:"address"}],outputs:[{name:"",type:"uint32"}],stateMutability:"view"},{type:"function",name:"startEntry",inputs:[{name:"roundId",type:"uint256"}],outputs:[],stateMutability:"payable"},{type:"function",name:"startAttempt",inputs:[{name:"roundId",type:"uint256"}],outputs:[],stateMutability:"nonpayable"},{type:"function",name:"endAttempt",inputs:[{name:"roundId",type:"uint256"}],outputs:[],stateMutability:"nonpayable"},{type:"function",name:"createRound",inputs:[{name:"entryFee",type:"uint256"},{name:"duration",type:"uint256"}],outputs:[{name:"roundId",type:"uint256"}],stateMutability:"nonpayable"},{type:"function",name:"finalizeRound",inputs:[{name:"roundId",type:"uint256"}],outputs:[],stateMutability:"nonpayable"},{type:"function",name:"getPlayers",inputs:[{name:"roundId",type:"uint256"}],outputs:[{name:"",type:"address[]"}],stateMutability:"view"},{type:"function",name:"getScore",inputs:[{name:"roundId",type:"uint256"},{name:"player",type:"address"}],outputs:[{name:"",type:"uint256"}],stateMutability:"view"},{type:"function",name:"joinRound",inputs:[{name:"roundId",type:"uint256"}],outputs:[],stateMutability:"payable"},{type:"function",name:"joined",inputs:[{name:"",type:"uint256"},{name:"",type:"address"}],outputs:[{name:"",type:"bool"}],stateMutability:"view"},{type:"function",name:"nextRoundId",inputs:[],outputs:[{name:"",type:"uint256"}],stateMutability:"view"},{type:"function",name:"rounds",inputs:[{name:"",type:"uint256"}],outputs:[{name:"creator",type:"address"},{name:"entryFee",type:"uint256"},{name:"startTime",type:"uint256"},{name:"endTime",type:"uint256"},{name:"pool",type:"uint256"},{name:"finalized",type:"bool"},{name:"playerCount",type:"uint256"}],stateMutability:"view"},{type:"function",name:"submitAction",inputs:[{name:"roundId",type:"uint256"}],outputs:[],stateMutability:"nonpayable"},{type:"function",name:"submitActions",inputs:[{name:"roundId",type:"uint256"},{name:"amount",type:"uint256"}],outputs:[],stateMutability:"nonpayable"},{type:"event",name:"EntryStarted",inputs:[{name:"roundId",type:"uint256",indexed:!0},{name:"player",type:"address",indexed:!0},{name:"entryIndex",type:"uint32",indexed:!1}]},{type:"event",name:"AttemptStarted",inputs:[{name:"roundId",type:"uint256",indexed:!0},{name:"player",type:"address",indexed:!0},{name:"entryIndex",type:"uint32",indexed:!1},{name:"attemptNumber",type:"uint8",indexed:!1}]},{type:"event",name:"AttemptEnded",inputs:[{name:"roundId",type:"uint256",indexed:!0},{name:"player",type:"address",indexed:!0},{name:"entryIndex",type:"uint32",indexed:!1},{name:"attemptsUsed",type:"uint8",indexed:!1},{name:"attemptScore",type:"uint256",indexed:!1},{name:"entryTotalScore",type:"uint256",indexed:!1},{name:"bestScore",type:"uint256",indexed:!1}]},{type:"event",name:"OperatorSet",inputs:[{name:"player",type:"address",indexed:!0},{name:"operator",type:"address",indexed:!0},{name:"allowed",type:"bool",indexed:!1}]},{type:"event",name:"ObstaclePassed",inputs:[{name:"roundId",type:"uint256",indexed:!0},{name:"player",type:"address",indexed:!0},{name:"entryIndex",type:"uint32",indexed:!0},{name:"obstacleCount",type:"uint32",indexed:!1},{name:"deltaScore",type:"uint32",indexed:!1},{name:"attemptScore",type:"uint256",indexed:!1},{name:"bestScore",type:"uint256",indexed:!1}]},{type:"event",name:"ActionsSubmitted",inputs:[{name:"roundId",type:"uint256",indexed:!0},{name:"player",type:"address",indexed:!0},{name:"amount",type:"uint256",indexed:!1},{name:"newScore",type:"uint256",indexed:!1}]},{type:"event",name:"ActionSubmitted",inputs:[{name:"roundId",type:"uint256",indexed:!0},{name:"player",type:"address",indexed:!0},{name:"newScore",type:"uint256",indexed:!1}]},{type:"event",name:"RoundCreated",inputs:[{name:"roundId",type:"uint256",indexed:!0},{name:"creator",type:"address",indexed:!0},{name:"entryFee",type:"uint256",indexed:!1},{name:"startTime",type:"uint256",indexed:!1},{name:"endTime",type:"uint256",indexed:!1}]},{type:"event",name:"RoundFinalized",inputs:[{name:"roundId",type:"uint256",indexed:!0},{name:"winner",type:"address",indexed:!0},{name:"payout",type:"uint256",indexed:!1},{name:"fee",type:"uint256",indexed:!1}]},{type:"event",name:"RoundJoined",inputs:[{name:"roundId",type:"uint256",indexed:!0},{name:"player",type:"address",indexed:!0}]}],g="0x8Cf51b3e1137C88961edBcb24F374c241C0EC472",v={chainId:"0x18C7",chainName:"MegaETH Testnet",rpcUrls:["https://carrot.megaeth.com/rpc"],nativeCurrency:{name:"Ether",symbol:"ETH",decimals:18},blockExplorerUrls:["https://megaeth-testnet-v2.blockscout.com/"]};async function w(e){let{currentChainId:t,switchChainAsync:n}=e;if(n&&6343!==t)try{await n({chainId:6343});return}catch(t){if(!function(e){var t,n,r,a,i,s,l,u,o,d;if(4902===(null!=(d=null!=(o=null!=(u=null==e?void 0:e.code)?u:null==e||null==(n=e.cause)?void 0:n.code)?o:null==e||null==(a=e.data)||null==(r=a.originalError)?void 0:r.code)?d:null==e||null==(l=e.cause)||null==(s=l.data)||null==(i=s.originalError)?void 0:i.code))return!0;let c=String(null!=(t=null==e?void 0:e.message)?t:"").toLowerCase();return c.includes("unrecognized chain")||c.includes("unknown chain")||c.includes("not added")}(t))throw t;let e=window.ethereum;if(!(null==e?void 0:e.request))throw t;await e.request({method:"wallet_addEthereumChain",params:[v]}),await n({chainId:6343})}}function S(e){let{active:t,onDistance:n,onCrash:a,entrySeedBase:i,attemptNumber:s,onCombo:l,onFeedback:o}=e,d=(0,u.useRef)(n),c=(0,u.useRef)(a),p=(0,u.useRef)(l),y=(0,u.useRef)(o);(0,u.useEffect)(()=>{d.current=n},[n]),(0,u.useEffect)(()=>{c.current=a},[a]),(0,u.useEffect)(()=>{p.current=l},[l]),(0,u.useEffect)(()=>{y.current=o},[o]);let m=(0,u.useRef)(null),f=(0,u.useRef)(null),[h,b]=(0,u.useState)("ready"),x=(0,u.useRef)("ready"),[g,v]=(0,u.useState)(0),w=(0,u.useRef)(0),[S,M]=(0,u.useState)(!1),j=(0,u.useRef)(!1);(0,u.useEffect)(()=>{j.current=S},[S]);let N=(0,u.useRef)({y:0,vy:0,slidingUntil:0,dashingUntil:0}),R=(0,u.useRef)([]),C=(0,u.useRef)(0),E=(0,u.useRef)(0),T=(0,u.useRef)(0),I=(0,u.useRef)(0),k=(0,u.useRef)(!1),P=(0,u.useRef)(0x12345678),A=(e,t,n)=>e+(t-e)*n,_=e=>{let t=Math.max(0,Math.min(1,e));return t*t*(3-2*t)},F=e=>e<=8?.3*_(e/8):e<=24?A(.3,.65,_((e-8)/16)):e<=70?A(.65,1,_((e-24)/46)):1,D=()=>{let e=0|P.current;return e^=e<<13,e^=e>>>17,P.current=0|(e^=e<<5),(e>>>0)/0x100000000},B=(0,u.useMemo)(()=>({gravity:2400,jumpVy:-820,difficulty:{speed:{start:280,end:520,maxDashBonus:80},spawnGapPx:{start:520,end:190,min:175,jitterFrac:.18},hitboxPadPx:{start:8,end:2},highObstacleHeight:{start:40,end:52},highObstacleChance:{start:.18,end:.48}},obstacleW:34,runnerX:82,runnerW:22,runnerH:34,runnerSlideH:18,groundPad:24,slideMs:420,dashMs:220,holdToSlideMs:180,coyoteMs:90,jumpBufferMs:110,startGraceDistancePx:520}),[]);function L(){var e;N.current={y:0,vy:0,slidingUntil:0,dashingUntil:0},R.current=[],C.current=0,w.current=0,v(0),k.current=!1,E.current=0,null==(e=p.current)||e.call(p,0),P.current=(e=>{let t=0x811c9dc5;for(let n=0;n<e.length;n++)t^=e.charCodeAt(n),t=Math.imul(t,0x1000193);return 0|t})("".concat(null!=i?i:"local","|").concat(null!=s?s:1)),T.current=performance.now(),I.current=0,x.current="ready",b("ready")}function H(){t&&"ready"===x.current&&(x.current="running",b("running"))}(0,u.useEffect)(()=>{if(!t)return void L();L(),x.current="running",b("running")},[t,i,s]);let O=(e,t)=>!(I.current<=e)&&(.01>Math.abs(N.current.y-t)||e-T.current<=B.coyoteMs)&&(N.current.vy=B.jumpVy,I.current=0,!0),U=(0,u.useRef)({}),[z,W]=(0,u.useState)(0);(0,u.useEffect)(()=>{let e=(e,t)=>{if(U.current[e])return;let n=new Image;n.decoding="async",n.loading="eager",n.src=t,n.onload=()=>W(e=>e+1),U.current[e]=n},t="/mega-rally-testnet/v/20260208015030",n=e=>new URL("".concat(t).concat(e),window.location.origin).toString();e("fluffle_run1",n("/sprites/fluffle_run1.svg")),e("fluffle_run2",n("/sprites/fluffle_run2.svg")),e("fluffle_slide",n("/sprites/fluffle_slide.svg")),e("ob_shard",n("/sprites/obstacle_shard.svg")),e("ob_drone",n("/sprites/obstacle_drone.svg")),e("ob_pylon",n("/sprites/obstacle_pylon.svg")),e("ob_tree",n("/sprites/obstacle_tree.svg"))},[]),(0,u.useEffect)(()=>{if(!t){f.current&&cancelAnimationFrame(f.current),f.current=null,x.current="ready",b("ready");return}let e=m.current;if(!e)return;let n=e.getContext("2d");if(!n)return;let r=performance.now(),a=B.startGraceDistancePx,i=performance.now(),s=()=>{let t=Math.max(1,Math.floor(window.devicePixelRatio||1)),{width:r,height:a}=e.getBoundingClientRect();e.width=Math.floor(r*t),e.height=Math.floor(a*t),n.setTransform(t,0,0,t,0,0);let i=a-B.groundPad;0===N.current.y&&(N.current.y=i)};s(),window.addEventListener("resize",s);let l=e=>{"d"===e.key.toLowerCase()&&M(e=>!e)};window.addEventListener("keydown",l);let u=t=>{let s=Math.min(.033,(t-r)/1e3);if(r=t,"running"===x.current){var l,o,m,h,g;let n=F(C.current),r=performance.now(),u=r<N.current.dashingUntil,f=A(B.difficulty.speed.start,B.difficulty.speed.end,n)+(u?B.difficulty.speed.maxDashBonus:0),S=e.clientWidth,M=e.clientHeight-B.groundPad;if(N.current.vy+=B.gravity*s,N.current.y+=N.current.vy*s,N.current.y>M?(N.current.y=M,N.current.vy=0,T.current=r):.01>Math.abs(N.current.y-M)&&(T.current=r),O(r,M),w.current>=a){let e=A(B.difficulty.highObstacleChance.start,B.difficulty.highObstacleChance.end,n),t=D()<1-e?"low":"high",r=Math.round(A(B.difficulty.highObstacleHeight.start,B.difficulty.highObstacleHeight.end,n)),i="low"===t?["ob_shard","ob_pylon","ob_tree"]:["ob_drone"],s=i[Math.floor(D()*i.length)]||("low"===t?"ob_shard":"ob_drone");R.current.push({x:S+40,w:B.obstacleW,h:"low"===t?26:r,kind:t,skin:s});let l=A(B.difficulty.spawnGapPx.start,B.difficulty.spawnGapPx.end,n),u=(2*D()-1)*B.difficulty.spawnGapPx.jitterFrac,o=Math.max(B.difficulty.spawnGapPx.min,l*(1+u));a=w.current+o}for(let e of R.current)e.x-=f*s;for(let e of(r<N.current.slidingUntil?B.runnerSlideH:B.runnerH,N.current.y,R.current))if(!e.passed&&e.x+e.w<B.runnerX&&(e.passed=!0,C.current+=1,E.current+=1,null==(l=p.current)||l.call(p,E.current),"low"===e.kind)){let t=M-e.h-N.current.y;t>=0&&t<=3?null==(o=y.current)||o.call(y,"perfect"):t>=0&&t<=8&&(null==(m=y.current)||m.call(y,"near"))}R.current=R.current.filter(e=>e.x>-e.w-20);let j=f*s;w.current+=j,d.current(j/10),t-i>250&&(i=t,v(w.current)),(()=>{let t=e.clientWidth,n=e.clientHeight;if(!t||!n)return!1;let r=n-B.groundPad,a=performance.now(),i=a<N.current.slidingUntil,s=a<N.current.dashingUntil,l=B.runnerX,u=B.runnerW,o=i?B.runnerSlideH:B.runnerH,d=N.current.y-o,c=F(C.current),p=Math.round(A(B.difficulty.hitboxPadPx.start,B.difficulty.hitboxPadPx.end,c)+3*!!s);for(let e of R.current){let t=e.x,n=r-e.h,a=e.w,i=e.h;if(l+p<t+a&&l+u-p>t&&d+p<n+i&&d+o-p>n)return!0}return!1})()&&(x.current="crashed",b("crashed"),E.current=0,null==(h=p.current)||h.call(p,0),k.current||(k.current=!0,null==(g=c.current)||g.call(c)))}(()=>{let t=e.clientWidth,r=e.clientHeight,a=r-B.groundPad,i=F(C.current),s="rgba(".concat(Math.round(7+10*i),",").concat(Math.round(10+8*i),",").concat(Math.round(22+28*i),",1)"),l=n.createLinearGradient(0,0,0,r);l.addColorStop(0,s),l.addColorStop(1,"rgba(7,10,18,1)"),n.fillStyle=l,n.fillRect(0,0,t,r);let u=Math.round(.18*r),o=Math.round(.34*r),d=.06*w.current%44;for(let e=-2;e<Math.ceil(t/44)+2;e++){let t=Math.floor(.06*w.current/44)+e,r=Math.round(40+Math.abs(Math.sin(999.13*t))%1*o),a=44*e-d,i=u+(o-r);n.fillStyle="rgba(11,18,32,0.85)",n.fillRect(a,i,38,r);let s=.18+.12*Math.sin(.002*w.current+t);n.fillStyle="rgba(34,211,238,".concat(Math.max(0,s),")"),n.fillRect(a+10,i+14,6,2),n.fillStyle="rgba(255,43,214,".concat(Math.max(0,.7*s),")"),n.fillRect(a+22,i+22,8,2)}n.fillStyle="rgba(255,255,255,0.03)";for(let e=0;e<r;e+=4)n.fillRect(0,e,t,1);n.strokeStyle="rgba(34,211,238,0.18)",n.lineWidth=1;for(let e=0;e<t;e+=28)n.beginPath(),n.moveTo(e-.6*w.current%28,a),n.lineTo(e-.6*w.current%28,r),n.stroke();let c=n.createLinearGradient(0,a,0,r);for(let e of(c.addColorStop(0,"rgba(34,211,238,0.18)"),c.addColorStop(1,"rgba(0,0,0,0.0)"),n.fillStyle=c,n.fillRect(0,a,t,r-a),R.current)){let t=a-e.h,r=U.current[e.skin];if((null==r?void 0:r.complete)&&r.naturalWidth>0){if(n.save(),"low"===e.kind)n.drawImage(r,e.x-10,t-18,e.w+20,e.h+30);else{let a=Math.max(24,Math.round(.6*e.h));n.drawImage(r,e.x-22,t-a,e.w+44,e.h+a+30)}n.restore();continue}if(n.save(),n.lineWidth=2,n.strokeStyle="rgba(0,0,0,0.75)","low"===e.kind){let r=e.w/4;n.beginPath(),n.moveTo(e.x,a);for(let i=0;i<4;i++){let s=e.x+i*r;n.lineTo(s+r/2,t),n.lineTo(s+r,a)}n.closePath(),n.fillStyle="#fbbf24",n.fill(),n.stroke()}else n.fillStyle="#22d3ee",n.fillRect(e.x,t,e.w,e.h),n.strokeRect(e.x,t,e.w,e.h);n.restore()}let p=performance.now()<N.current.slidingUntil,y=N.current.y<a-1,m=B.runnerW,f=p?B.runnerSlideH:B.runnerH,h=B.runnerX,b=N.current.y-f,g=Math.floor(w.current/80%2),v=U.current[p?"fluffle_slide":0===g?"fluffle_run1":"fluffle_run2"];if((null==v?void 0:v.complete)&&v.naturalWidth>0){if(n.save(),y&&(n.translate(h+m/2,b+f/2),n.rotate(-.12),n.translate(-(h+m/2),-(b+f/2))),p){let e=1.5*f;n.drawImage(v,h-.5*m,N.current.y-e+2,2.2*m,e)}else n.drawImage(v,h-.55*m,b-.65*f,2.1*m,2.1*f);n.restore()}else{let e=Math.max(10,Math.min(m,f)/2);n.save(),n.beginPath(),n.arc(h+m/2,b+f/2,e,0,2*Math.PI),n.closePath(),n.fillStyle="#ffd6ff",n.shadowColor="rgba(255,43,214,0.75)",n.shadowBlur=16,n.fill(),n.shadowBlur=0,n.lineWidth=2,n.strokeStyle="rgba(255,43,214,0.95)",n.stroke(),p&&(n.strokeStyle="rgba(255,255,255,0.55)",n.lineWidth=2,n.beginPath(),n.moveTo(h-10,N.current.y-2),n.lineTo(h+m+18,N.current.y-2),n.stroke()),n.restore()}if(j.current){for(let e of(n.save(),n.strokeStyle="rgba(255,255,255,0.65)",n.lineWidth=1,n.strokeRect(h,b,m,f),n.strokeStyle="rgba(251,191,36,0.75)",R.current)){let t=a-e.h;n.strokeRect(e.x,t,e.w,e.h)}n.restore()}n.fillStyle="rgba(255,255,255,0.85)",n.font="600 14px ui-monospace, SFMono-Regular, Menlo, monospace","ready"===x.current?n.fillText("Tap to JUMP • hold to SLIDE",14,22):"crashed"===x.current&&n.fillText("CRASHED",14,22),j.current&&(n.save(),n.fillStyle="rgba(0,0,0,0.55)",n.fillRect(10,10,240,74),n.strokeStyle="rgba(34,211,238,0.7)",n.lineWidth=1,n.strokeRect(10,10,240,74),n.fillStyle="rgba(255,255,255,0.92)",n.font="12px ui-monospace, SFMono-Regular, Menlo, monospace",n.fillText("debug: ON (press 'd' to toggle)",16,28),n.fillText("obstacles: ".concat(R.current.length),16,44),n.fillText("canvas: ".concat(Math.round(t),"x").concat(Math.round(r)," dpr:").concat(Math.round(window.devicePixelRatio||1)),16,60),n.fillText("status: ".concat(x.current),16,76),n.restore());let S=n.createRadialGradient(t/2,r/2,.2*Math.min(t,r),t/2,r/2,.75*Math.max(t,r));S.addColorStop(0,"rgba(0,0,0,0)"),S.addColorStop(1,"rgba(0,0,0,0.55)"),n.fillStyle=S,n.fillRect(0,0,t,r)})(),f.current=requestAnimationFrame(u)};return f.current=requestAnimationFrame(u),()=>{f.current&&cancelAnimationFrame(f.current),f.current=null,window.removeEventListener("resize",s),window.removeEventListener("keydown",l)}},[t,B]);let q=(0,u.useRef)(null),G=(0,u.useRef)(0),J=(0,u.useRef)(!1),Q=()=>{q.current&&window.clearTimeout(q.current),q.current=null};return(0,r.jsxs)("div",{className:"dash-root",style:{position:"relative"},onPointerDown:e=>{e.preventDefault(),t&&"crashed"!==x.current&&(G.current=Date.now(),J.current=!1,Q(),q.current=window.setTimeout(()=>{J.current=!0,function(e){if(t&&(H(),"running"===x.current)){if(e<N.current.slidingUntil){N.current.dashingUntil=e+B.dashMs;return}N.current.slidingUntil=e+B.slideMs}}(Date.now())},B.holdToSlideMs))},onPointerUp:e=>{if(e.preventDefault(),!t||(Q(),"crashed"===x.current))return;let n=Date.now()-G.current;J.current||n>=B.holdToSlideMs||function(e){var n,r;if(!t||(H(),"running"!==x.current))return;let a=null!=(r=null==(n=m.current)?void 0:n.clientHeight)?r:0;if(!a)return;let i=a-B.groundPad;I.current=Math.max(I.current,e+B.jumpBufferMs),O(e,i)}(Date.now())},onPointerCancel:()=>{Q()},onContextMenu:e=>e.preventDefault(),children:[(0,r.jsx)("div",{style:{position:"absolute",top:0,left:0,width:42,height:42,opacity:.01},onPointerDown:e=>{e.preventDefault();let t=e.currentTarget,n=Date.now(),r=Number(t.dataset.lastTap||0),a=Number(t.dataset.taps||0),i=n-r<550?a+1:1;t.dataset.lastTap=String(n),t.dataset.taps=String(i),i>=5&&(t.dataset.taps="0",M(e=>!e))}}),(0,r.jsx)("canvas",{ref:m,className:"dash-canvas"})]})}function M(e){let{address:t,demo:n}=e,a=!!n,[i,s]=(0,u.useState)(null),[l,v]=(0,u.useState)([]),[M,j]=(0,u.useState)(0),[N,R]=(0,u.useState)(0n),[C,E]=(0,u.useState)(!1),[T,I]=(0,u.useState)(null),k=(0,u.useRef)(null),P=(0,u.useRef)(!0),[A,_]=(0,u.useState)(0),[F,D]=(0,u.useState)(0),[B,L]=(0,u.useState)(0n),[H,O]=(0,u.useState)(0n),[U,z]=(0,u.useState)(0),[W,q]=(0,u.useState)(!1),[G,J]=(0,u.useState)(!1),[Q,X]=(0,u.useState)(0),[V,Y]=(0,u.useState)(null),K=(0,u.useRef)(null),[Z,$]=(0,u.useState)(0);(0,u.useEffect)(()=>()=>{K.current&&window.clearTimeout(K.current),K.current=null},[]),(0,u.useEffect)(()=>(P.current=!0,()=>{P.current=!1,k.current&&window.clearTimeout(k.current),k.current=null}),[]);let ee=(0,u.useCallback)(function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2500;P.current&&(I(e),k.current&&window.clearTimeout(k.current),k.current=window.setTimeout(()=>{P.current&&I(null)},t))},[]),et=(0,o.e)(),en=(0,d.i)(),{switchChainAsync:er}=(0,c.R)(),{writeContractAsync:ea,isPending:ei}=(0,p.x)(),es=a||6343===en,[el,eu]=(0,u.useState)(!1),[eo,ed]=(0,u.useState)(null),[ec,ep]=(0,u.useState)(!1),[ey]=(0,u.useState)(.01),[em,ef]=(0,u.useState)(0),[eh,eb]=(0,u.useState)([]),[ex,eg]=(0,u.useState)(1),[ev,ew]=(0,u.useState)(0),[eS,eM]=(0,u.useState)(0n),[ej,eN]=(0,u.useState)(0n);(0,u.useEffect)(()=>{if(!a||null!==eo)return;let e=Math.floor(Date.now()/1e3);s(0n),ed(e+120),eb([t,"0x000000000000000000000000000000000000dEaD","0x000000000000000000000000000000000000bEEF"]),v([{address:t,score:0n},{address:"0x000000000000000000000000000000000000dEaD",score:3n},{address:"0x000000000000000000000000000000000000bEEF",score:1n}]),ef(.03),eu(!0),eg(1),ew(0),eM(0n),eN(0n),q(!1),R(0n)},[a,eo,t]),(0,u.useEffect)(()=>{if(!a||!eo)return;let e=()=>{j(Math.max(0,eo-Math.floor(Date.now()/1e3)))};e();let t=setInterval(e,1e3);return()=>clearInterval(t)},[a,eo]),(0,u.useEffect)(()=>{if(!a||ec)return;let e=setInterval(()=>{v(e=>{let n=e.map(e=>({...e}));for(let e of n)e.address.toLowerCase()!==t.toLowerCase()&&.55>Math.random()&&(e.score=e.score+1n);return n.sort((e,t)=>t.score>e.score?1:t.score<e.score?-1:0),n})},2500);return()=>clearInterval(e)},[a,ec,t]);let{data:eR,refetch:eC}=(0,y.Q)({address:g,abi:x,functionName:"nextRoundId",query:{enabled:!a&&es}});(0,u.useEffect)(()=>{!a&&void 0!==eR&&eR>0n&&s(eR-1n)},[eR,a]);let{data:eE,refetch:eT}=(0,y.Q)({address:g,abi:x,functionName:"rounds",args:null!==i?[i]:void 0,query:{enabled:!a&&es&&null!==i}}),{data:eI}=(0,y.Q)({address:g,abi:x,functionName:"joined",args:null!==i?[i,t]:void 0,query:{enabled:!a&&es&&null!==i}}),{data:ek,refetch:eP}=(0,y.Q)({address:g,abi:x,functionName:"entryIndex",args:null!==i?[i,t]:void 0,query:{enabled:!a&&es&&null!==i}}),{data:eA,refetch:e_}=(0,y.Q)({address:g,abi:x,functionName:"attemptsUsed",args:null!==i?[i,t]:void 0,query:{enabled:!a&&es&&null!==i}}),{data:eF,refetch:eD}=(0,y.Q)({address:g,abi:x,functionName:"currentAttemptScore",args:null!==i?[i,t]:void 0,query:{enabled:!a&&es&&null!==i}}),{data:eB,refetch:eL}=(0,y.Q)({address:g,abi:x,functionName:"totalScore",args:null!==i?[i,t]:void 0,query:{enabled:!a&&es&&null!==i}}),[eH,eO,eU,ez,eW,eq,eG]=null!=eE?eE:[void 0,0n,0n,0n,0n,!1,0n],eJ=eo?BigInt(eo):0n,eQ=a?eJ:null!=ez?ez:0n,eX=a?ec:null!=eq&&eq,eV=a?(0,f.g)(ey.toString()):null!=eO?eO:0n,eY=a?(0,f.g)(em.toString()):null!=eW?eW:0n,eK=a?BigInt(eh.length):null!=eG?eG:0n,eZ=a?el:(null!=ek?ek:0)>0,e$=BigInt(Math.floor(Date.now()/1e3)),e0=eQ>0n&&e$<eQ&&!eX,e1=eQ>0n&&e$>=eQ;(0,u.useEffect)(()=>{if(!e0){q(!1),J(!1);return}a?($(ex),D(ev),L(eS),O(ej+eS)):($(Number(null!=ek?ek:0)),D(Number(null!=eA?eA:0)),L(null!=eF?eF:0n),O(null!=eB?eB:0n))},[e0,a,ex,ev,eS,ej,ek,eA,eF,eB]),(0,u.useEffect)(()=>{if(a||!ez||0n===ez)return;let e=()=>{j(Math.max(0,Number(ez)-Math.floor(Date.now()/1e3)))};e();let t=setInterval(e,1e3);return()=>clearInterval(t)},[ez,a]);let e2=(0,u.useCallback)(async()=>{if(!a&&es&&null!==i&&et)try{let e=await et.readContract({address:g,abi:x,functionName:"getPlayers",args:[i]}),n=await Promise.all(e.map(async e=>{let t=await et.readContract({address:g,abi:x,functionName:"getScore",args:[i,e]});return{address:e,score:t}}));n.sort((e,t)=>t.score>e.score?1:t.score<e.score?-1:0),v(n);let r=n.find(e=>e.address.toLowerCase()===t.toLowerCase());r&&R(r.score)}catch(e){}},[i,et,t,a,es]);(0,u.useEffect)(()=>{e2()},[e2]),(0,u.useEffect)(()=>{if(a||!es||!e0)return;let e=setInterval(e2,3e3);return()=>clearInterval(e)},[e0,e2,a,es]),(0,m.x)({address:g,abi:x,eventName:"ActionsSubmitted",enabled:!a&&es,onLogs(){e2(),e_(),eD(),eL()}}),(0,m.x)({address:g,abi:x,eventName:"EntryStarted",enabled:!a&&es,onLogs(){eP(),e_(),eD(),eL()}}),(0,m.x)({address:g,abi:x,eventName:"AttemptEnded",enabled:!a&&es,onLogs(){e_(),eD(),eL(),e2()}});let e5=(0,u.useRef)(0),e6=(0,u.useRef)(null),e3=(0,u.useRef)(0),e4=(0,u.useRef)(0),e8=e0&&eZ&&Z>0&&!W&&F<3&&!G;(0,u.useEffect)(()=>{if(!e8)return void z(0);let e=0,t=0,n=r=>{r-t>=50&&(t=r,z(e5.current)),e=requestAnimationFrame(n)};return e=requestAnimationFrame(n),()=>cancelAnimationFrame(e)},[e8]);let e9=(0,u.useCallback)(async e=>{if(!e8)return;if(a){let e=Math.floor(e5.current);if(e<=0)return;e5.current-=e,eM(t=>t+BigInt(e)),v(n=>{let r=n.map(e=>({...e})),a=r.findIndex(e=>e.address.toLowerCase()===t.toLowerCase());return a>=0&&(r[a].score=r[a].score+BigInt(e)),r.sort((e,t)=>t.score>e.score?1:t.score<e.score?-1:0),r});return}if(!e0||!eZ||null===i||e6.current)return;let n=Date.now(),r=Math.floor(e5.current);if(r<=0)return;let s=n-e3.current;if(e||!(r<25)||!(s<3e3)){e5.current-=r,e6.current={amount:r},e3.current=n;try{await ea({address:g,abi:x,functionName:"submitActions",args:[i,BigInt(r)]}),e2(),eD(),eL()}catch(e){e5.current+=r}finally{e6.current=null}}},[e8,a,e0,eZ,i,ea,e2,t,eD,eL]),e7=(0,u.useCallback)(e=>{if(!e8||e<=0)return;e5.current+=e;let t=Date.now();t-e4.current>=50&&(e4.current=t,z(e5.current)),e9()},[e8,e9]);(0,u.useEffect)(()=>{if(!e8)return;let e=setInterval(()=>{e9()},500);return()=>clearInterval(e)},[e8,e9]);let te=(0,u.useCallback)(async()=>{if(e0&&eZ&&!G){J(!0);try{if(await e9(!0),a)eN(e=>e+eS+BigInt(Math.floor(e5.current))),eM(0n),e5.current=0,ew(e=>Math.min(3,e+1));else{if(null===i)return;await ea({address:g,abi:x,functionName:"endAttempt",args:[i]}),e_(),eD(),eL(),e2(),e5.current=0}}finally{J(!1)}}},[e0,eZ,G,e9,a,eS,i,ea,e_,eD,eL,e2]),tt=(0,u.useCallback)(async()=>{q(!0);try{await te()}catch(e){}},[te]);async function tn(){if(_(e=>e+1),console.log("[MegaRally] Create Round tapped"),a){let e=Math.floor(Date.now()/1e3);ep(!1),ed(e+120),v([{address:t,score:0n},{address:"0x000000000000000000000000000000000000dEaD",score:0n},{address:"0x000000000000000000000000000000000000bEEF",score:0n}]),ef(.03),eu(!0),eg(1),ew(0),eM(0n),eN(0n),e5.current=0,q(!1),R(0n);return}try{await ea({address:g,abi:x,functionName:"createRound",args:[(0,f.g)("0.01"),120n]})}catch(e){if(e instanceof h.vx||(null==e?void 0:e.name)==="UserRejectedRequestError")return void ee("Transaction rejected.");console.error("[MegaRally] createRound failed",e),ee("Create round failed.");return}P.current&&await eC()}async function tr(){let e;if(a){eu(!0),eg(1),ew(0),eM(0n),eN(0n),e5.current=0,q(!1);return}if(null!==i&&void 0!==eO){try{e=await ea({address:g,abi:x,functionName:"startEntry",args:[i],value:eO})}catch(e){if(e instanceof h.vx||(null==e?void 0:e.name)==="UserRejectedRequestError")return void ee("Transaction rejected.");console.error("[MegaRally] startEntry failed",e),ee("Join failed.");return}try{et&&await et.waitForTransactionReceipt({hash:e})}catch(e){}if(await eT(),await eP(),e0)try{let e=await ea({address:g,abi:x,functionName:"startAttempt",args:[i]});try{et&&await et.waitForTransactionReceipt({hash:e})}catch(e){}}catch(e){}e_(),eD(),eL(),e2()}}async function ta(){let e;if(e0){if(a){eg(e=>e+1),ew(0),eM(0n),eN(0n),e5.current=0,q(!1);return}if(null!==i&&void 0!==eO){try{e=await ea({address:g,abi:x,functionName:"startEntry",args:[i],value:eO})}catch(e){if(e instanceof h.vx||(null==e?void 0:e.name)==="UserRejectedRequestError")return void ee("Transaction rejected.");console.error("[MegaRally] startEntry (new entry) failed",e),ee("New entry failed.");return}try{et&&await et.waitForTransactionReceipt({hash:e})}catch(e){}eP(),e_(),eD(),eL(),e2(),e5.current=0,q(!1)}}}async function ti(){if(a)return void ep(!0);if(null!==i){try{await ea({address:g,abi:x,functionName:"finalizeRound",args:[i]})}catch(e){if(e instanceof h.vx||(null==e?void 0:e.name)==="UserRejectedRequestError")return void ee("Transaction rejected.");console.error("[MegaRally] finalizeRound failed",e),ee("Finalize failed.");return}P.current&&(await eT(),e2())}}let[ts,tl]=(0,u.useState)(!1),tu=(0,u.useCallback)(async()=>{tl(!0);try{await w({currentChainId:en,switchChainAsync:er})}catch(e){}finally{tl(!1)}},[en,er]),to=Math.min(3,F+1),td=(0,u.useMemo)(()=>{var e;let n=null!=(e=null==i?void 0:i.toString())?e:"0",r=(null!=t?t:"0x0000000000000000000000000000000000000000").toLowerCase(),a=String(Z);return"".concat(en,":").concat(g,":").concat(n,":").concat(r,":").concat(a)},[en,i,t,Z]),tc=(0,u.useCallback)(e=>{Y(e),K.current&&window.clearTimeout(K.current),K.current=window.setTimeout(()=>Y(null),"perfect"===e?420:520)},[]);if(!a&&6343!==en)return(0,r.jsxs)("div",{className:"no-round",children:[(0,r.jsx)("p",{style:{marginBottom:8},children:"Wrong network."}),(0,r.jsxs)("p",{style:{opacity:.85,fontSize:14,marginBottom:12},children:["Switch your wallet to ",(0,r.jsx)("b",{children:"MegaETH Testnet"})," (chainId ",6343,")."]}),(0,r.jsx)("button",{className:"action-btn",onClick:tu,disabled:ts,children:ts?"Switching…":"Switch to MegaETH Testnet"})]});if(a&&null===i)return(0,r.jsx)("div",{className:"no-round",children:(0,r.jsx)("p",{children:"Starting demo…"})});if(null===i||!a&&0n===eR)return(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"no-round",children:(0,r.jsx)("p",{children:"No rounds yet"})}),(0,r.jsx)("button",{className:"action-btn",onClick:tn,disabled:ei,children:ei?"Creating...":"Create Round (0.01 ETH, 2 min)"}),(0,r.jsxs)("div",{style:{textAlign:"center",marginTop:8,fontSize:12,opacity:.7},"aria-live":"polite",children:["Tap count: ",A]}),T&&(0,r.jsx)("div",{style:{textAlign:"center",marginTop:8,fontSize:12,opacity:.9},"aria-live":"polite",children:T})]});let tp=Math.max(0,Math.trunc(U)),ty=B+BigInt(tp),tm=H+BigInt(tp);return(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"card",children:[(0,r.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,r.jsxs)("h2",{children:["Round #",i.toString()]}),(0,r.jsx)("span",{className:"badge ".concat(e0?"badge-active":"badge-ended"),children:eX?"Finalized":e0?"Active":"Ended"})]}),!a&&(0,r.jsxs)("div",{className:"round-info",style:{marginTop:8},children:[(0,r.jsxs)("span",{children:["Entry: ",(0,b.c)(eV)," ETH"]}),(0,r.jsxs)("span",{children:["Pool: ",(0,b.c)(eY)," ETH"]}),(0,r.jsxs)("span",{children:["Players: ",eK.toString()]})]})]}),T&&(0,r.jsx)("div",{style:{textAlign:"center",marginTop:10,fontSize:12,opacity:.9},"aria-live":"polite",children:T}),e0&&(0,r.jsxs)("div",{className:"dash-wrap",children:[(0,r.jsxs)("div",{className:"dash-topbar","aria-live":"polite",children:[(0,r.jsxs)("div",{className:"dash-topbar-left",children:[(0,r.jsx)("div",{className:"dash-topbar-label",children:"ENTRY"}),(0,r.jsxs)("div",{className:"dash-topbar-value",children:["#",Z]}),(0,r.jsx)("div",{className:"dash-topbar-label",style:{marginTop:6},children:"ATTEMPT"}),(0,r.jsxs)("div",{className:"dash-topbar-value",children:[to,"/",3]}),(0,r.jsx)("div",{className:"dash-topbar-label",style:{marginTop:6},children:"COMBO"}),(0,r.jsx)("div",{className:"dash-topbar-value",children:Q})]}),(0,r.jsxs)("div",{className:"dash-topbar-score",children:[(0,r.jsx)("div",{className:"dash-topbar-label",children:"SCORE"}),(0,r.jsx)("div",{className:"dash-topbar-score-value",children:ty.toString()}),V&&(0,r.jsx)("div",{className:"dash-topbar-label",style:{marginTop:6,color:"perfect"===V?"#22d3ee":"#fbbf24"},children:"perfect"===V?"PERFECT":"NEAR"})]}),(0,r.jsxs)("div",{className:"dash-topbar-right",children:[(0,r.jsx)("div",{className:"dash-topbar-label",children:"TOTAL"}),(0,r.jsx)("div",{className:"dash-topbar-value",children:tm.toString()})]})]}),(0,r.jsx)("button",{className:"dash-standings",onClick:()=>E(!0),children:"Standings"}),(0,r.jsx)(S,{active:e8,entrySeedBase:td,attemptNumber:to,onDistance:e7,onCrash:tt,onCombo:X,onFeedback:tc},"attempt-".concat(F,"-").concat(W?"over":"run")),!eZ&&(0,r.jsx)("div",{className:"dash-overlay",children:(0,r.jsxs)("div",{className:"dash-overlay-inner",children:[(0,r.jsx)("p",{style:{marginBottom:10,opacity:.9},children:"Join to start dashing."}),(0,r.jsx)("button",{className:"action-btn",onClick:tr,disabled:ei,children:ei?"Joining...":a?"Join Round (demo)":"Join Round (".concat((0,b.c)(eV)," ETH)")})]})}),eZ&&F>=3&&(0,r.jsx)("div",{className:"dash-overlay",children:(0,r.jsxs)("div",{className:"dash-overlay-inner",children:[(0,r.jsx)("p",{style:{marginBottom:10,opacity:.9},children:"All attempts used for this entry."}),(0,r.jsx)("p",{style:{marginBottom:12,opacity:.75,fontSize:13},children:"Leaderboard keeps your best entry. Start a new entry to retry with a new seed."}),(0,r.jsx)("button",{className:"action-btn",onClick:ta,disabled:ei,children:ei?"Starting...":a?"Start New Entry (demo)":"Start New Entry (".concat((0,b.c)(eV)," ETH)")})]})}),eZ&&W&&F<3&&(0,r.jsx)("div",{className:"dash-overlay",children:(0,r.jsxs)("div",{className:"dash-overlay-inner",children:[(0,r.jsx)("p",{style:{marginBottom:6,fontWeight:800},children:"Attempt over"}),(0,r.jsxs)("p",{style:{marginBottom:12,opacity:.8,fontSize:13},children:["Attempt score: ",ty.toString()," • Total: ",tm.toString()]}),(0,r.jsx)("button",{className:"action-btn",onClick:async()=>{if(!a&&(null!=B?B:0n)>0n)try{await te()}catch(e){}if(!a&&null!==i)try{await ea({address:g,abi:x,functionName:"startAttempt",args:[i]}),e_(),eD(),eL()}catch(e){}q(!1),e5.current=0},disabled:G,children:G?"Locking...":"Next Attempt"})]})})]}),e1&&!eX&&(0,r.jsx)("button",{className:"action-btn",onClick:ti,disabled:ei,children:ei?"Finalizing...":a?"Finalize (demo)":"Finalize Round"}),(eX||e1)&&(0,r.jsx)("button",{className:"action-btn",onClick:tn,disabled:ei,children:ei?"Creating...":a?"Restart Demo Round":"Create New Round"}),C&&(0,r.jsx)("div",{className:"drawer-backdrop",onClick:()=>E(!1),children:(0,r.jsxs)("div",{className:"drawer",onClick:e=>e.stopPropagation(),children:[(0,r.jsxs)("div",{className:"drawer-header",children:[(0,r.jsx)("h3",{children:"Standings"}),(0,r.jsx)("button",{className:"drawer-close",onClick:()=>E(!1),children:"Close"})]}),0===l.length?(0,r.jsx)("p",{style:{color:"var(--muted)"},children:"No players yet"}):(0,r.jsx)("ul",{className:"leaderboard",children:l.map((e,n)=>{let a;return(0,r.jsxs)("li",{children:[(0,r.jsxs)("span",{className:"rank",children:["#",n+1]}),(0,r.jsx)("span",{className:"addr",children:e.address.toLowerCase()===t.toLowerCase()?"You":(a=e.address,"".concat(a.slice(0,6),"...").concat(a.slice(-4)))}),(0,r.jsx)("span",{className:"score",children:e.score.toString()})]},e.address)})}),(0,r.jsxs)("div",{className:"status",style:{marginTop:10},children:["Attempt score: ",B.toString()," • Attempts used: ",F,"/",3]}),!a&&(0,r.jsx)("div",{className:"status",style:{marginTop:6},children:"Batched commits every ~3s (or when distance builds up). No per-action tx spam."})]})})]})}function j(){let{address:e,isConnected:t}=(0,a.F)(),{connect:n}=(0,i.e)(),{disconnect:u}=(0,s.u)();return(0,r.jsxs)("div",{className:"container",children:[(0,r.jsxs)("header",{className:"header",children:[(0,r.jsx)("h1",{children:"MegaRally"}),t?(0,r.jsxs)("button",{className:"connect-btn",onClick:()=>u(),children:[null==e?void 0:e.slice(0,6),"...",null==e?void 0:e.slice(-4)]}):(0,r.jsx)("button",{className:"connect-btn",onClick:()=>n({connector:(0,l.b)()}),children:"Connect"})]}),t?(0,r.jsx)(M,{address:e,demo:!1}):(0,r.jsx)("div",{className:"no-round",children:(0,r.jsx)("p",{children:"Connect your wallet to play"})})]})}},9249:(e,t,n)=>{Promise.resolve().then(n.bind(n,639))}},e=>{e.O(0,[496,109,441,255,358],()=>e(e.s=9249)),_N_E=e.O()}]);